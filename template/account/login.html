{% extends "base.html" %}
{% block title %}
用户登录
{% endblock %}

{% block javascriptblock %}

{% endblock %}

{% block body %}
<div ms-controller="login">
    <div class="am-g">
        <div class="am-u-lg-6 am-u-md-8 am-u-sm-centered">
            <hr>
            <h2>登录</h2>
            <hr>
            <div class="am-form">

                <label for="email">账号:</label>
                <input type="email" name="" id="email" ms-duplex="username">
                <br>
                <label for="password">密码:</label>
                <input type="password" name="" id="password" ms-duplex="password">
                <br/>

                <div class="am-cf">
                    <button class="am-btn am-btn-primary am-btn-sm am-fl" ms-click="submit">登录</button>

                    <a class="am-btn am-btn-default am-btn-sm am-fr" href="/register/">忘记密码</a>
                    <a class="am-btn am-btn-success am-btn-sm am-fr" href="/register/">注册</a>
                </div>
            </div>
        </div>
    </div>
    <div class="am-modal am-modal-alert" id="login_alert">
        <div class="am-modal-dialog">
            <div class="am-modal-hd"></div>
            <div class="am-modal-bd">
                { alert_content }
            </div>
            <div class="am-modal-footer">
                <span class="am-modal-btn">确定</span>
            </div>
        </div>
    </div>
</div>
{% include 'foot.html' %}
<script>
    avalon.ready(function () {
        avalon.config({
            interpolate: ["{", "}"]
        });
        var vm = avalon.define({
            $id: "login",

            username: "",
            password: "",
            alert_content: "",
            submit: function () {
                if (vm.username == "" || vm.password == "") {
                    vm.alert_content = "请输入账号和密码";
                    $('#login_alert').modal();
                }
                else {
                    $.ajax({
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("X-CSRFToken", csrf_token());
                        },
                        data: {username: vm.username, password: vm.password},
                        url: "/login/",
                        method: "post",
                        success: function(data){

                            if (data.status == "success"){
                                window.location.href = document.referrer;
                            }
                            else{
                                vm.alert_content = data.content;
                                $('#login_alert').modal();
                            }
                        }
                    });
                }
            }
        });

        avalon.scan();
    });
</script>
{% endblock %}